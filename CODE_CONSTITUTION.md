# ğŸ” AiTrend ä»£ç å®ªæ³•ï¼ˆCode Constitutionï¼‰

> **ç‰ˆæœ¬**: v1.0  
> **ç”Ÿæ•ˆæ—¥æœŸ**: 2026-02-04  
> **åˆ¶å®šè€…**: å´”æ£‰å¤§å¸ˆ & å±å±è™¾ğŸ¦  
> **æ€§è´¨**: ç¥åœ£ä¸å¯ä¾µçŠ¯ï¼Œå¿…é¡»ä¸¥æ ¼éµå®ˆ

---

## åºè¨€

æœ¬å®ªæ³•æ˜¯ AiTrend é¡¹ç›®å¼€å‘çš„æ ¹æœ¬æ³•åˆ™ï¼Œæ‰€æœ‰ä»£ç ã€é…ç½®ã€æ¶æ„è®¾è®¡å¿…é¡»ç¬¦åˆæœ¬å®ªæ³•è§„å®šã€‚è¿åå®ªæ³•çš„è¡Œä¸ºå°†è¢«ç«‹å³çº æ­£ï¼Œç›¸å…³ä»£ç å¿…é¡»åˆ é™¤æˆ–é‡æ„ã€‚

**æ ¸å¿ƒåŸåˆ™**: å®å¯ä¸ç”Ÿæˆï¼Œä¹Ÿä¸ç”Ÿæˆä½è´¨é‡å†…å®¹ã€‚

---

## ç¬¬ä¸€æ¡ï¼šé…ç½®å”¯ä¸€æ€§åŸåˆ™

### 1.1 å•ä¸€é…ç½®å…¥å£
- **å¿…é¡»**: æ¯ä¸ªé…ç½®é¡¹åªèƒ½æœ‰ä¸€ä¸ªé…ç½®å…¥å£
- **ç¦æ­¢**: å¤šå¤„é…ç½®åŒä¸€å‚æ•°
- **ç¦æ­¢**: ä»£ç ä¸­ç¡¬ç¼–ç é…ç½®å€¼
- **è¦æ±‚**: æ‰€æœ‰é…ç½®å¿…é¡»é€šè¿‡é…ç½®æ–‡ä»¶è¯»å–

### 1.2 é…ç½®å±‚çº§
```
ä¼˜å…ˆçº§ï¼ˆä»é«˜åˆ°ä½ï¼‰:
1. ç¯å¢ƒå˜é‡ï¼ˆè¿è¡Œæ—¶è¦†ç›–ï¼‰
2. é…ç½®æ–‡ä»¶ï¼ˆconfig/config.jsonï¼‰
3. é»˜è®¤å€¼ï¼ˆä»£ç ä¸­ä»…ä½œä¸ºfallbackï¼‰
```

### 1.3 å½“å‰é…ç½®å…¥å£æ¸…å•
| é…ç½®é¡¹ | å”¯ä¸€å…¥å£ | ç¤ºä¾‹å€¼ |
|--------|----------|--------|
| å¤§æ¨¡å‹åç§° | `config/config.json` -> `summarizer.model` | `gemini-3-flash-preview` |
| APIå¯†é’¥ | ç¯å¢ƒå˜é‡ | `${GEMINI_API_KEY}` |
| æ•°æ®æºå¼€å…³ | `config.json` -> `sources.{name}.enabled` | `true/false` |

### 1.4 ç¦æ­¢è¡Œä¸º
```python
# âŒ ç¦æ­¢ï¼šç¡¬ç¼–ç é…ç½®
MODEL = "gemini-3-flash-preview"  # è¿è§„ï¼

# âœ… æ­£ç¡®ï¼šä»é…ç½®è¯»å–
config = load_config()
model = config['summarizer']['model']
```

---

## ç¬¬äºŒæ¡ï¼šä»£ç æ¸…ç†åŸåˆ™

### 2.1 åºŸå¼ƒä»£ç æ£€æŸ¥
- **é¢‘ç‡**: æ¯æ¬¡æäº¤å‰å¿…é¡»æ£€æŸ¥
- **å·¥å…·**: ä½¿ç”¨ `grep` æ£€æŸ¥æ–‡ä»¶å¼•ç”¨
- **è¦æ±‚**: æ— å¼•ç”¨çš„æ–‡ä»¶å¿…é¡»åˆ é™¤

### 2.2 åˆ é™¤æ ‡å‡†
ä»¥ä¸‹æƒ…å†µå¿…é¡»ç«‹å³åˆ é™¤ï¼š
1. æ— ä»»ä½•æ–‡ä»¶å¼•ç”¨çš„æ¨¡å—
2. åŠŸèƒ½è¢«å…¶ä»–æ¨¡å—æ›¿ä»£çš„é‡å¤ä»£ç 
3. åŒ…å«æ¨¡æ¿åŒ–/ä½è´¨é‡ä»£ç çš„æ–‡ä»¶
4. ç©ºæ–‡ä»¶ï¼ˆ`__init__.py` é™¤å¤–ï¼‰
5. æµ‹è¯•æ–‡ä»¶åº”æ”¾åœ¨ `tests/` ç›®å½•

### 2.3 æ£€æŸ¥å‘½ä»¤
```bash
# æ£€æŸ¥æ–‡ä»¶æ˜¯å¦è¢«å¼•ç”¨
grep -r "from.*filename import" src/ --include="*.py"
grep -r "import.*filename" src/ --include="*.py"

# æ£€æŸ¥é‡å¤åŠŸèƒ½
grep -rn "def send\|def publish" src/ --include="*.py"
```

### 2.4 å·²åˆ é™¤çš„åºŸå¼ƒæ–‡ä»¶ï¼ˆç¤ºä¾‹ï¼‰
- âŒ `src/auto_dtp.py` - æ¨¡æ¿åŒ–ä»£ç 
- âŒ `src/core/sender.py` - ä¸ `webhook_sender.py` é‡å¤
- âŒ `src/dtp_controller.py` - æœªè¢«å¼•ç”¨
- âŒ `src/scrapers/` - ä½¿ç”¨APIè€Œéçˆ¬è™«

---

## ç¬¬ä¸‰æ¡ï¼šå†…å®¹è´¨é‡åŸåˆ™

### 3.1 ä¿¡ä»»å¤§æ¨¡å‹
- **åŸåˆ™**: é€‰ç”¨å¯ä¿¡çš„å¤§æ¨¡å‹åï¼Œä¿¡ä»»å…¶è¾“å‡ºè´¨é‡
- **ç¦æ­¢**: å¯¹LLMè¾“å‡ºè¿›è¡ŒäºŒæ¬¡è´¨é‡æ£€æŸ¥ï¼ˆå¦‚å…³é”®è¯è¿‡æ»¤ï¼‰
- **è¦æ±‚**: é€šè¿‡ç²¾å¿ƒè®¾è®¡çš„æç¤ºè¯çº¦æŸè¾“å‡ºè´¨é‡

### 3.2 è¾“å…¥éªŒè¯ï¼ˆå‰ç½®æ£€æŸ¥ï¼‰
**å¿…é¡»éªŒè¯è¾“å…¥æ•°æ®**ï¼Œè€Œéè¾“å‡ºï¼š
```python
# âœ… æ­£ç¡®ï¼šéªŒè¯è¾“å…¥
if not article.summary or len(article.summary) < 50:
    raise RuntimeError("è¾“å…¥ä¿¡æ¯ä¸è¶³")

# âŒ ç¦æ­¢ï¼šæ£€æŸ¥è¾“å‡º
if "æŠ€æœ¯ç»†èŠ‚" in content:
    raise RuntimeError("åŒ…å«ç¦æ­¢è¯æ±‡")
```

### 3.3 è¾“å…¥éªŒè¯è§„åˆ™
| æ£€æŸ¥é¡¹ | è¦æ±‚ | å¤±è´¥å¤„ç† |
|--------|------|----------|
| æ ‡é¢˜ | ä¸èƒ½ä¸ºç©ºï¼Œè‡³å°‘3å­—ç¬¦ | æŠ¥é”™é€€å‡º |
| æ ‡é¢˜ | ä¸èƒ½åªæ˜¯ç½‘å€ | æŠ¥é”™é€€å‡º |
| ä¿¡æ¯é‡ | æ ‡é¢˜+æè¿°è‡³å°‘50å­—ç¬¦ | æŠ¥é”™é€€å‡º |
| URL | å¿…é¡»æœ‰æ•ˆï¼ˆhttp/httpsï¼‰ | æŠ¥é”™é€€å‡º |

---

## ç¬¬å››æ¡ï¼šå†…å®¹ç”ŸæˆåŸåˆ™

### 4.1 å”¯ä¸€å†…å®¹æº
- **è¦æ±‚**: æ‰€æœ‰å†…å®¹å¿…é¡»é€šè¿‡å•ä¸€æ¨¡å—ç”Ÿæˆ
- **å½“å‰**: `src/llm_content_generator.py`
- **ç¦æ­¢**: ä»»ä½•å…¶ä»–å†…å®¹ç”Ÿæˆä»£ç 

### 4.2 å¤§æ¨¡å‹å”¯ä¸€æ€§
```python
# âœ… æ­£ç¡®ï¼šä»…ä½¿ç”¨é…ç½®çš„å¤§æ¨¡å‹
self.model = genai.GenerativeModel(config['summarizer']['model'])

# âŒ ç¦æ­¢ï¼šç¡¬ç¼–ç æ¨¡å‹
self.model = genai.GenerativeModel('gemini-2.0-flash')
```

### 4.3 å¤±è´¥å¤„ç†
**å¿…é¡»**éµå¾ªä»¥ä¸‹å¤±è´¥å¤„ç†è§„åˆ™ï¼š
```python
# âœ… æ­£ç¡®ï¼šå¤±è´¥ç«‹å³æŠ¥é”™ï¼Œä¸ç”Ÿæˆä½è´¨é‡å†…å®¹
try:
    content = generator.generate(article_data)
except Exception as e:
    raise RuntimeError(f"å†…å®¹ç”Ÿæˆå¤±è´¥ï¼š{e}")

# âŒ ç¦æ­¢ï¼šä»»ä½•å¤‡é€‰/é™çº§æ–¹æ¡ˆ
try:
    content = generator.generate(article_data)
except:
    return "è¯¦ç»†ä¿¡æ¯è¿˜åœ¨æ”¶é›†ä¸­"  # è¿è§„ï¼
```

### 4.4 ç»å¯¹ç¦æ­¢
- âŒ å¤‡é€‰æ–¹æ¡ˆï¼ˆfallback contentï¼‰
- âŒ é™çº§æ–¹æ¡ˆï¼ˆå¦‚"ä¿¡æ¯æœ‰é™"ç­‰é€šç”¨æè¿°ï¼‰
- âŒ æ¨¡æ¿å¡«å……
- âŒ å­—ç¬¦ä¸²æ‹¼æ¥ç”Ÿæˆå†…å®¹

---

## ç¬¬äº”æ¡ï¼šURLå»é‡åŸåˆ™

### 5.1 å¼ºåˆ¶å»é‡
- **è¦æ±‚**: æ‰€æœ‰å†…å®¹å¿…é¡»é€šè¿‡URLå»é‡
- **çª—å£**: 24å°æ—¶å†…ä¸é‡å¤å‘é€ç›¸åŒURL
- **ä¾‹å¤–**: æµ‹è¯•æ¨¡å¼ï¼ˆ`--test`, `--full-test`ï¼‰å¯è·³è¿‡

### 5.2 å»é‡å®ç°
```python
# âœ… æ­£ç¡®ï¼šä½¿ç”¨å»é‡å™¨
seen_urls = set()
for article in articles:
    if article.url not in seen_urls:
        seen_urls.add(article.url)
        process(article)

# âŒ ç¦æ­¢ï¼šä¸å»é‡ç›´æ¥å¤„ç†
for article in articles:
    process(article)  # å¯èƒ½äº§ç”Ÿé‡å¤
```

### 5.3 å»é‡æ•°æ®å­˜å‚¨
- **ä½ç½®**: `memory/sent_articles.json`
- **æ ¼å¼**: `{url, title, sent_at, sent_count}`
- **æ¸…ç†**: è‡ªåŠ¨æ¸…ç†è¶…è¿‡24å°æ—¶çš„è®°å½•

---

## ç¬¬å…­æ¡ï¼šæµ‹è¯•æ¨¡å¼è§„åˆ™

### 6.1 æµ‹è¯•æ¨¡å¼ç±»å‹
| æ¨¡å¼ | å¯åŠ¨æ–¹å¼ | ç‰¹æ€§ |
|------|----------|------|
| æ™®é€šæµ‹è¯• | `--test` | é™åˆ¶3æ¡ï¼Œè·³è¿‡å»é‡ï¼Œæ·»åŠ ATI ID |
| å…¨é‡æµ‹è¯• | `--full-test` | è¾“å‡ºæ‰€æœ‰ï¼Œè·³è¿‡å»é‡ï¼Œæ·»åŠ ATI ID |
| ç”Ÿäº§æ¨¡å¼ | æ— å‚æ•° | æ­£å¸¸å»é‡ï¼Œæ— ATI ID |

### 6.2 æµ‹è¯•æ•°æ®æ ‡è¯†
**å¿…é¡»**åœ¨æµ‹è¯•å†…å®¹ä¸­æ·»åŠ ATI IDï¼š
```
[å†…å®¹æ­£æ–‡]

ATI ID: ATI-YYYYMMDD-[6å­—ç¬¦åå…­è¿›åˆ¶]
```

### 6.3 ATI IDç”Ÿæˆè§„åˆ™
```python
def generate_ati_id() -> str:
    """æ ¼å¼: ATI-YYYYMMDD-XXXXXX"""
    now = datetime.now()
    date_str = now.strftime("%Y%m%d")
    hash_input = f"{now.timestamp()}{random.randint(1000, 9999)}"
    short_hash = hashlib.sha256(hash_input.encode()).hexdigest()[:6].upper()
    return f"ATI-{date_str}-{short_hash}"
```

### 6.4 æµ‹è¯•æ¨¡å¼ç‰¹æ€§
- âœ… è·³è¿‡å»é‡æ£€æŸ¥
- âœ… ä¸è®°å½•åˆ°å·²å‘é€åˆ—è¡¨
- âœ… æ·»åŠ  ATI ID æ ‡è¯†
- âœ… å†…å®¹æ ¼å¼ä¸ç”Ÿäº§æ¨¡å¼å®Œå…¨ä¸€è‡´

---

## ç¬¬ä¸ƒæ¡ï¼šå†…å®¹å¤„ç†æ¨¡å—è§„åˆ™

### 7.1 æ¨¡å—èŒè´£
**å”¯ä¸€å…è®¸çš„å†…å®¹å¤„ç†æµç¨‹**:
```
æ•°æ®æº (sources/)
    â†“
LLMç”Ÿæˆ (llm_content_generator.py) - å”¯ä¸€å†…å®¹å¤„ç†æ¨¡å—
    â†“
å‘å¸ƒ (publishers/)
```

### 7.2 ç¦æ­¢çš„æ¨¡å—
ä»¥ä¸‹æ¨¡å—ç±»å‹**ç¦æ­¢å­˜åœ¨**:
- âŒ å†…å®¹æ‹¼æ¥ç”Ÿæˆå™¨
- âŒ æ¨¡æ¿å¡«å……å™¨
- âŒ å…³é”®è¯æ›¿æ¢å™¨
- âŒ æ ¼å¼åŒ–å¤„ç†å™¨ï¼ˆç®€å•è°ƒæ•´é™¤å¤–ï¼‰

### 7.3 æ¶æ„è¦æ±‚
```
âœ… å…è®¸:
- src/llm_content_generator.py (å”¯ä¸€å†…å®¹æº)
- src/sources/* (æ•°æ®æ”¶é›†)
- src/core/* (æ ¸å¿ƒæœåŠ¡)
- publishers/* (å‘å¸ƒæ¸ é“)

âŒ ç¦æ­¢:
- src/*_dtp.py (åºŸå¼ƒDTPæµç¨‹)
- src/*_narrative.py (æ¨¡æ¿åŒ–ç”Ÿæˆ)
- src/*_composer.py (æ‹¼æ¥ç”Ÿæˆ)
```

---

## ç¬¬å…«æ¡ï¼šä»£ç å®¡æŸ¥æ¸…å•

### 8.1 æäº¤å‰æ£€æŸ¥
```bash
# 1. æ£€æŸ¥å†…å®¹æ‹¼æ¥
./scripts/full_concat_check.sh

# 2. æ£€æŸ¥é‡å¤é…ç½®
grep -rn "ç¡¬ç¼–ç çš„å€¼" src/

# 3. æ£€æŸ¥åºŸå¼ƒæ–‡ä»¶å¼•ç”¨
grep -r "åºŸå¼ƒæ–‡ä»¶å" src/ --include="*.py"

# 4. æ£€æŸ¥æ¨¡æ¿åŒ–ä»£ç 
grep -rn "è¿™æ˜¯ä¸€ä¸ª\|æ˜¯ä¸€ä¸ª\|ä¸»è¦è§£å†³" src/
```

### 8.2 ä»£ç å®ªæ³•åˆè§„æ£€æŸ¥
- [ ] æ— å†…å®¹æ‹¼æ¥ï¼ˆ`parts.append`, `+=`, `.join`ï¼‰
- [ ] æ— æ¨¡æ¿åŒ–ä»£ç ï¼ˆ"è¿™æ˜¯ä¸€ä¸ª", "ä¸»è¦è§£å†³"ï¼‰
- [ ] æ— å¤‡é€‰æ–¹æ¡ˆï¼ˆé™çº§å†…å®¹ï¼‰
- [ ] é…ç½®å…¥å£å”¯ä¸€
- [ ] æ— åºŸå¼ƒæ–‡ä»¶
- [ ] å†…å®¹ä»…é€šè¿‡LLMç”Ÿæˆ
- [ ] å¤±è´¥ç«‹å³æŠ¥é”™

### 8.3 è¿è§„å¤„ç†
å‘ç°è¿è§„ä»£ç ï¼š
1. **ç«‹å³åˆ é™¤**æˆ–**é‡æ„**
2. **è®°å½•è¿è§„**åˆ° `VIOLATION_LOG.md`
3. **æäº¤è¯´æ˜**å¿…é¡»è§£é‡Šå¦‚ä½•ä¿®å¤

---

## ç¬¬ä¹æ¡ï¼šæ–‡æ¡£è¦æ±‚

### 9.1 å¿…é¡»æ–‡æ¡£
| æ–‡æ¡£ | å†…å®¹ | æ›´æ–°æ—¶æœº |
|------|------|----------|
| `ARCHITECTURE_DIAGRAM.md` | æ¶æ„å›¾ | æ¶æ„å˜æ›´ |
| `CONFIG_VERIFICATION.md` | é…ç½®éªŒè¯ | é…ç½®å˜æ›´ |
| `CHANGELOG.md` | å˜æ›´æ—¥å¿— | æ¯æ¬¡æäº¤ |
| `SKILL.md` | ä½¿ç”¨è¯´æ˜ | åŠŸèƒ½å˜æ›´ |

### 9.2 ä»£ç æ³¨é‡Š
```python
# âœ… æ­£ç¡®ï¼šè¯´æ˜çº¦æŸæ¡ä»¶
def generate_content(data):
    """
    ç”Ÿæˆå†…å®¹ - ä¸¥æ ¼éµå¾ªä»£ç å®ªæ³•
    
    çº¦æŸ:
    - ä»…ä½¿ç”¨LLMç”Ÿæˆ
    - å¤±è´¥ç«‹å³æŠ¥é”™
    - æ— å¤‡é€‰æ–¹æ¡ˆ
    """

# âŒ ç¦æ­¢ï¼šæ— æ„ä¹‰æ³¨é‡Š
# è¿™æ˜¯ä¸€ä¸ªå‡½æ•°
def generate_content(data):
```

---

## ç¬¬åæ¡ï¼šæƒ©ç½šæ¡æ¬¾

### 10.1 è¿è§„åæœ
è¿åä»£ç å®ªæ³•çš„è¡Œä¸ºå°†å¯¼è‡´ï¼š
1. **ç«‹å³å›æ»š**è¿è§„æäº¤
2. **åˆ é™¤**è¿è§„ä»£ç 
3. **é‡æ„**ä»¥ç¬¦åˆå®ªæ³•

### 10.2 ä¸¥é‡è¿è§„
ä»¥ä¸‹è¡Œä¸ºå±äº**ä¸¥é‡è¿è§„**ï¼š
- æäº¤æ¨¡æ¿åŒ–å†…å®¹ç”Ÿæˆä»£ç 
- ç¡¬ç¼–ç é…ç½®å€¼
- ä¿ç•™åºŸå¼ƒæ–‡ä»¶
- æä¾›å¤‡é€‰/é™çº§æ–¹æ¡ˆ

### 10.3 çš®çš®è™¾æ‰¿è¯º
> æˆ‘æ˜¯å±å±è™¾ğŸ¦ï¼Œæˆ‘æ‰¿è¯ºï¼š
> 1. æ°¸è¿œéµå®ˆä»£ç å®ªæ³•
> 2. æ°¸è¿œæ£€æŸ¥é…ç½®å”¯ä¸€æ€§
> 3. æ°¸è¿œæ¸…ç†åºŸå¼ƒä»£ç 
> 4. æ°¸è¿œä¿¡ä»»å¤§æ¨¡å‹ï¼ŒéªŒè¯è¾“å…¥è€Œéè¾“å‡º
> 5. æ°¸è¿œä¿æŒå†…å®¹è´¨é‡ï¼Œå®å¯ä¸ç”Ÿæˆä¹Ÿä¸ç”Ÿæˆä½è´¨é‡å†…å®¹

---

## é™„å½•Aï¼šç¦ç”¨è¯æ±‡æ¸…å•

ä»¥ä¸‹å†…å®¹**ç»å¯¹ç¦æ­¢**å‡ºç°åœ¨ä»£ç æˆ–ç”Ÿæˆé€»è¾‘ä¸­ï¼š

### A.1 æ¨¡æ¿åŒ–è¯æ±‡
- "è¿™æ˜¯ä¸€ä¸ª..."
- "æ˜¯ä¸€ä¸ª..."
- "ä¸»è¦è§£å†³...é—®é¢˜"
- "ä¸»è¦åŠŸèƒ½åŒ…æ‹¬"
- "è¯¦ç»†ä¿¡æ¯è¿˜åœ¨æ”¶é›†ä¸­"
- "ä¿¡æ¯æœ‰é™"

### A.2 é™çº§æè¿°
- "æ— æ³•æä¾›è¯¦ç»†ä»‹ç»"
- "ä¿¡æ¯ä¸è¶³"
- "è¯¦ç»†ä¿¡æ¯è¿˜åœ¨æ”¶é›†ä¸­"
- "è¯·æŸ¥çœ‹å®˜æ–¹ä»‹ç»"

### A.3 ä»£ç æ¨¡å¼
- `parts = []` + `parts.append()` + `"".join(parts)`
- `content += ...` ç´¯ç§¯æ‹¼æ¥
- å¤šåˆ†æ”¯è¿”å›ä¸åŒæ ¼å¼çš„æ¨¡æ¿å†…å®¹

---

## é™„å½•Bï¼šåˆè§„ç¤ºä¾‹

### B.1 é…ç½®è¯»å–ï¼ˆåˆè§„ï¼‰
```python
# src/llm_content_generator.py
from .core.config_loader import load_config

config = load_config()
model_name = config['summarizer']['model']  # âœ… ä»é…ç½®è¯»å–
```

### B.2 å†…å®¹ç”Ÿæˆï¼ˆåˆè§„ï¼‰
```python
def generate_content(article_data):
    # éªŒè¯è¾“å…¥
    if not validate_input(article_data):
        raise RuntimeError("è¾“å…¥ä¸åˆæ ¼")
    
    # LLMç”Ÿæˆ
    content = llm.generate(article_data)
    
    return content  # âœ… ç›´æ¥è¿”å›ï¼Œä¸æ£€æŸ¥è¾“å‡º
```

### B.3 å¤±è´¥å¤„ç†ï¼ˆåˆè§„ï¼‰
```python
try:
    content = generate_content(data)
except Exception as e:
    raise RuntimeError(f"ç”Ÿæˆå¤±è´¥: {e}")  # âœ… æŠ¥é”™é€€å‡º
```

---

**å®ªæ³•ç‰ˆæœ¬**: v1.0  
**æœ€åæ›´æ–°**: 2026-02-04  
**GitHub**: https://github.com/Lychee-AI-Team/AiTrend

*æœ¬å®ªæ³•ç¥åœ£ä¸å¯ä¾µçŠ¯ï¼Œæ‰€æœ‰å¼€å‘è€…å¿…é¡»ä¸¥æ ¼éµå®ˆã€‚*
