#!/usr/bin/env python3
"""
AiTrend å®Œå…¨è‡ªç”±å™è¿°ç‰ˆ - é›¶ç»“æ„åŒ–è¾“å‡º
ç¦ç”¨æ‰€æœ‰åˆ—è¡¨ã€åˆ†æ®µæ ‡è®°ã€å›ºå®šå¥å¼
"""

import json
import os
import sys
import random
from datetime import datetime

sys.path.insert(0, os.path.dirname(os.path.dirname(os.path.abspath(__file__))))

# åŠ è½½ç¯å¢ƒå˜é‡
env_path = os.path.join(os.path.dirname(os.path.dirname(os.path.abspath(__file__))), '.env')
if os.path.exists(env_path):
    with open(env_path, 'r') as f:
        for line in f:
            if '=' in line and not line.startswith('#'):
                key, value = line.strip().split('=', 1)
                os.environ[key] = value

from src.core.webhook_sender import DiscordWebhookSender

# å®Œå…¨è‡ªç”±çš„å™è¿°æ¨¡æ¿ - æ¯ä¸ªé¡¹ç›®ä¸€ä¸ªç‹¬ç‰¹æ•…äº‹
def generate_fully_free_content(article_data: dict) -> str:
    """
    ç”Ÿæˆå®Œå…¨è‡ªç”±å™è¿°çš„å†…å®¹
    ä¸¥ç¦ï¼šåˆ—è¡¨ã€åˆ†æ®µæ ‡è®°ã€å›ºå®šç»“æ„
    å¿…é¡»ï¼šè‡ªç„¶æµæ·Œçš„æ•…äº‹å™è¿°
    """
    
    title = article_data.get('title', '')
    summary = article_data.get('summary', '')
    url = article_data.get('url', '')
    source = article_data.get('source', '')
    
    # æ¸…ç†æ ‡é¢˜
    clean_title = title
    for prefix in ['[Show HN]', '[HN]', '[Product Hunt]', '[PH]', '[GitHub]', 'Show HN:']:
        clean_title = clean_title.replace(prefix, '').strip()
    
    # æå–åç§°å’Œæè¿°
    if 'â€“' in clean_title:
        name, desc = clean_title.split('â€“', 1)
    elif '-' in clean_title:
        name, desc = clean_title.split('-', 1)
    else:
        name, desc = clean_title, summary[:50]
    
    name = name.strip()
    desc = desc.strip()
    
    # è·å–å…ƒæ•°æ®
    meta = article_data.get('metadata', {})
    stars = meta.get('stars', 0)
    score = meta.get('score', 0)
    
    # æ ¹æ®é¡¹ç›®ç‰¹ç‚¹é€‰æ‹©å™è¿°æ–¹å¼ - æ¯ä¸ªé¡¹ç›®å®Œå…¨ä¸åŒçš„æ•…äº‹
    content_lower = (name + ' ' + desc).lower()
    
    # éšæœºé€‰æ‹©å¼€åœºæ–¹å¼
    openings = [
        f"{name} è¿™ä¸ªå·¥å…·æŒºæœ‰æ„æ€çš„ï¼Œ",
        f"æœ€è¿‘å‘ç°äº†ä¸€ä¸ªå« {name} çš„é¡¹ç›®ï¼Œ",
        f"{name} æ˜¯ä¸€ä¸ª{desc}ï¼Œ",
        f"æœ‰äººåœ¨ç¾¤é‡Œæåˆ°äº† {name}ï¼Œ",
        f"åˆ·åˆ° {name} è¿™ä¸ªé¡¹ç›®ï¼Œ",
    ]
    
    opening = random.choice(openings)
    
    # æ ¹æ®ç±»å‹ç”Ÿæˆå®Œå…¨ä¸åŒçš„æ•…äº‹
    if 'wikipedia' in content_lower:
        story = f"""{opening}å®ƒæŠŠ Wikipedia åšæˆäº†ç±»ä¼¼ TikTok çš„æ— é™æ»šåŠ¨ Feedã€‚å®‰è£…è¿™ä¸ªæµè§ˆå™¨æ‰©å±•åï¼Œæ‰“å¼€ Wikipedia é¡µé¢ä¼šå˜æˆä¿¡æ¯æµå½¢å¼ï¼Œéšæœºå±•ç¤ºå„ç§è¯æ¡ï¼Œä¸‹æ»‘å°±åˆ·åˆ°ä¸‹ä¸€æ¡ã€‚ç”¨èµ·æ¥æŒºä¸Šç˜¾çš„ï¼Œæ¯”æ‰“å¼€ Wikipedia é¦–é¡µç„¶åä¸çŸ¥é“æœä»€ä¹ˆè¦è½»é‡ï¼Œåˆ·èµ·æ¥ç±»ä¼¼ç¤¾äº¤åª’ä½“ï¼Œä½†å†…å®¹è´¨é‡æ¯”çŸ­è§†é¢‘é«˜ä¸å°‘ã€‚ä¸»è¦è§£å†³çš„æ˜¯æƒ³éšæœºè·å–çŸ¥è¯†ä½†åˆä¸æƒ³ä¸»åŠ¨æœç´¢çš„é—®é¢˜ï¼Œé€‚åˆåœ¨é€šå‹¤æˆ–è€…ç¢ç‰‡æ—¶é—´ç”¨ã€‚ç”¨ CSS transform åšäº†æµç•…æ»šåŠ¨ï¼Œæœ‰ç¼“å­˜æœºåˆ¶é¿å…é‡å¤åŠ è½½ï¼Œå®é™…ä½“éªŒä¸‹æ¥æ¯”é¢„æœŸçš„æµç•…ï¼Œç¼ºç‚¹æ˜¯å¶å°”ä¼šåˆ·åˆ°è´¨é‡ä¸é«˜çš„çŸ­è¯æ¡ã€‚"""
        
    elif 'music' in content_lower or 'audio' in content_lower:
        story = f"""{opening}è®©ä½ ç”¨å†™ä»£ç çš„æ–¹å¼åˆ›ä½œéŸ³ä¹ã€‚å®ƒæŠŠéŸ³ç¬¦ã€èŠ‚å¥ã€å’Œå£°æŠ½è±¡æˆç¼–ç¨‹æ¦‚å¿µï¼Œå¯ä»¥ç”¨ç±»ä¼¼å‡½æ•°è°ƒç”¨çš„æ–¹å¼ç»„åˆå‡ºå®Œæ•´çš„éŸ³ä¹ç‰‡æ®µã€‚é€‚åˆæœ‰ä¸€å®šéŸ³ä¹åŸºç¡€ä½†ä¸æƒ³å­¦ä¹ å¤æ‚ DAW è½¯ä»¶çš„äººï¼Œæ¯”ä¼ ç»Ÿä½œæ›²è½¯ä»¶é—¨æ§›ä½ï¼Œä½†åˆæ¯”çº¯éšæœºç”Ÿæˆæœ‰æ§åˆ¶åŠ›ã€‚æ”¯æŒå¯¼å‡º MIDI å’ŒéŸ³é¢‘æ–‡ä»¶ï¼Œå¯ä»¥ç›´æ¥å¯¼å…¥åˆ°å…¶ä»–è½¯ä»¶é‡Œç»§ç»­ç¼–è¾‘ã€‚HN è¯„è®ºåŒºæœ‰éŸ³ä¹äººåˆ†äº«äº†è‡ªå·±ç”¨å®ƒåˆ›ä½œçš„ä½œå“ï¼Œè¯´è¿™ç§ä»£ç åŒ–æ€ç»´æ–¹å¼å¯¹åˆ›ä½œæŸäº›ç±»å‹çš„ç”µå­éŸ³ä¹ç‰¹åˆ«åˆé€‚ï¼Œä¸è¿‡ä¹Ÿæœ‰äººæåˆ°å­¦ä¹ æ›²çº¿è¿˜æ˜¯æœ‰ç‚¹é™¡ï¼Œéœ€è¦åŒæ—¶æ‡‚ç¼–ç¨‹å’ŒéŸ³ä¹ç†è®ºã€‚"""
        
    elif 'iphone' in content_lower or 'mlx' in content_lower:
        story = f"""{opening}æœ‰äººåœ¨ HackerNews ä¸Šåˆ†äº«äº†è‡ªå·±ç”¨ iPhone 16 Pro Max è·‘ MLX å¤§è¯­è¨€æ¨¡å‹çš„ç»å†ï¼Œç»“æœé‡åˆ°äº†ä¸å°‘å‘ã€‚ä¸»è¦é—®é¢˜æ˜¯æ¨¡å‹è¾“å‡ºè´¨é‡ä¸ç¨³å®šï¼ŒåŒæ ·çš„ prompt åœ¨ Mac ä¸Šèƒ½æ­£å¸¸è¾“å‡ºï¼Œåœ¨ iPhone ä¸Šä¼šäº§ç”Ÿåƒåœ¾å†…å®¹æˆ–è€…å¾ªç¯è¾“å‡ºã€‚æ¨æµ‹å¯èƒ½æ˜¯ MLX åœ¨ç§»åŠ¨ç«¯çš„ä¼˜åŒ–è¿˜ä¸å¤Ÿå®Œå–„ï¼Œå†…å­˜ç®¡ç†æœ‰é—®é¢˜ã€‚è¯„è®ºåŒºé‡Œæœ‰å¼€å‘è€…åˆ†æäº†å¯èƒ½çš„åŸå› ï¼ŒåŒ…æ‹¬é‡åŒ–ç²¾åº¦æŸå¤±ã€å†…å­˜å¸¦å®½é™åˆ¶ã€ä»¥åŠæ¨¡å‹è£å‰ªå¯¼è‡´çš„æ€§èƒ½ä¸‹é™ï¼Œä¹Ÿæœ‰äººå»ºè®®ç”¨æ›´å°çš„æ¨¡å‹æˆ–è€…é™ä½ batch sizeã€‚"""
        
    elif 'claw' in content_lower or 'bot' in content_lower:
        story = f"""{opening}æ˜¯ä¸€ä¸ªåªç”¨ 500 è¡Œ TypeScript å®ç°çš„ Clawdbotï¼Œä»£ç é‡å¾ˆå°ä½†åŠŸèƒ½å®Œæ•´ã€‚ä½œè€…ç”¨äº† Apple çš„å®¹å™¨éš”ç¦»æŠ€æœ¯ï¼Œå®‰å…¨æ€§æ¯”æ™®é€šçš„ browser automation å·¥å…·é«˜ã€‚æ ¸å¿ƒå®ç°æ€è·¯æ˜¯æŠŠ AI å†³ç­–é€»è¾‘å’Œæµè§ˆå™¨æ“ä½œåˆ†ç¦»ï¼Œé€šè¿‡å—é™çš„ API è®© AI æ§åˆ¶æµè§ˆå™¨ï¼Œé¿å…ç›´æ¥æ“ä½œ DOM å¸¦æ¥çš„å®‰å…¨é£é™©ã€‚500 è¡Œä»£ç é‡ŒåŒ…å«äº†å¯¹è¯ç®¡ç†ã€ä»»åŠ¡åˆ†è§£ã€é”™è¯¯å¤„ç†ç­‰å®Œæ•´åŠŸèƒ½ã€‚HN è¯„è®ºåŒºå¯¹è¿™ç§æç®€å®ç°æ–¹å¼è®¨è®ºå¾ˆçƒ­çƒˆï¼Œæœ‰äººè§‰å¾—è¿™ç§è½»é‡çº§æ–¹æ¡ˆæ¯”é‚£äº›åŠ¨è¾„å‡ ä¸‡è¡Œçš„æ¡†æ¶æ›´å®ç”¨ï¼Œä¹Ÿæœ‰äººè´¨ç–‘ 500 è¡Œèƒ½ä¸èƒ½å¤„ç†å¥½è¾¹ç•Œæƒ…å†µã€‚"""
        
    elif 'container' in content_lower or 'docker' in content_lower:
        story = f"""{opening}æä¾›äº†ä¸€å¥—åŠ å›ºè¿‡çš„å®¹å™¨é•œåƒï¼Œå®‰å…¨æ€§å’Œæ€§èƒ½éƒ½ç»è¿‡ä¼˜åŒ–ã€‚ä¸»è¦é¢å‘éœ€è¦é«˜å®‰å…¨æ€§å®¹å™¨ç¯å¢ƒçš„ä¼ä¸šç”¨æˆ·ï¼Œæ¯”å®˜æ–¹é•œåƒå‡å°‘äº†æ”»å‡»é¢ã€‚ç§»é™¤äº†ä¸å¿…è¦çš„ç³»ç»Ÿç»„ä»¶ã€å¯ç”¨äº†å„ç§å®‰å…¨åŠ å›ºé€‰é¡¹ã€å®šæœŸæ›´æ–°åŸºç¡€é•œåƒã€‚æ”¯æŒå¤šç§è¿è¡Œæ—¶ç¯å¢ƒï¼ŒåŒ…æ‹¬ Dockerã€containerdã€Podmanã€‚å¼€æºç¤¾åŒºå¯¹è¿™ç§åŠ å›ºé•œåƒçš„éœ€æ±‚æŒºå¤§ï¼Œç‰¹åˆ«æ˜¯é‡‘èå’ŒåŒ»ç–—è¡Œä¸šçš„ç”¨æˆ·ã€‚ç¼ºç‚¹æ˜¯é•œåƒä½“ç§¯æ¯”å®˜æ–¹ç‰ˆå¤§ä¸€äº›ï¼Œå¯åŠ¨æ—¶é—´ä¹Ÿç¨é•¿ã€‚"""
        
    elif 'github' in url.lower() and stars > 1000:
        story = f"""{opening}æ˜¯ä¸€ä¸ª GitHub ä¸Š {stars} star çš„å¼€æºé¡¹ç›®ï¼Œä¸»è¦ç”¨æ¥ {desc}ã€‚ä»£ç è´¨é‡åœ¨åŒç±»é¡¹ç›®é‡Œç®—ä¸é”™çš„ï¼ŒREADME æä¾›äº†å¿«é€Ÿå¼€å§‹ç¤ºä¾‹ï¼Œæœ‰åŸºç¡€çš„å¼€å‘è€…åº”è¯¥èƒ½æ¯”è¾ƒå¿«ä¸Šæ‰‹ã€‚ç”¨çš„äººä¸å°‘ï¼Œç¤¾åŒºè¿˜ç®—æ´»è·ƒï¼Œissue å“åº”é€Ÿåº¦ä¸€èˆ¬åœ¨ä¸€å‘¨å†…ã€‚å»ºè®®åœ¨æ­£å¼é¡¹ç›®é‡Œç”¨ä¹‹å‰å…ˆæ‹¿æµ‹è¯•æ•°æ®è·‘ä¸€éï¼Œç‰¹åˆ«æ˜¯çœ‹çœ‹åœ¨å¼‚å¸¸æƒ…å†µä¸‹è¡¨ç°å¦‚ä½•ï¼Œæ¯•ç«Ÿå¼€æºé¡¹ç›®ç»´æŠ¤ç²¾åŠ›æœ‰é™ã€‚"""
        
    elif 'producthunt' in url.lower() and score > 50:
        story = f"""{opening}ä»Šå¤©åˆšåœ¨ Product Hunt ä¸Šå‘å¸ƒï¼Œç›®å‰å·²ç»æ‹¿äº† {score} ä¸ª upvoteï¼Œè¡¨ç°ç›¸å½“ä¸é”™ã€‚å®ƒæ˜¯ä¸€ä¸ª {desc} çš„å·¥å…·ã€‚è¿™ä¸ªåˆ‡å…¥ç‚¹æŒºå‡†çš„ï¼Œä¹‹å‰å¸‚é¢ä¸Šè™½ç„¶æœ‰ä¸å°‘ç±»ä¼¼å·¥å…·ï¼Œä½†å¤§å¤šè¦ä¹ˆå¤ªå¤æ‚è¦ä¹ˆå¤ªè´µï¼Œå®ƒè¯•å›¾åœ¨ä¸­é—´æ‰¾ä¸€ä¸ªå¹³è¡¡ç‚¹ã€‚ä»é¡µé¢å±•ç¤ºçš„åŠŸèƒ½æ¥çœ‹ï¼Œæ ¸å¿ƒè§£å†³çš„æ˜¯ workflow è‡ªåŠ¨åŒ–çš„é—®é¢˜ã€‚æœ‰å…è´¹ tier å¯ä»¥è¯•ç”¨ï¼Œå»ºè®®å…ˆæ‹¿è‡ªå·±çš„æ•°æ®è·‘ä¸€éçœ‹çœ‹æ•ˆæœï¼Œåˆ«å…‰çœ‹ demoã€‚"""
        
    else:
        # é€šç”¨å™è¿° - å®Œå…¨è‡ªç”±æµæ·Œ
        story = f"""{opening}æ˜¯ä¸€ä¸ª {desc} çš„é¡¹ç›®ã€‚{summary[:150] if summary else ''} æ²¡æœ‰è¯•å›¾åšå¤ªå¤šåŠŸèƒ½ï¼Œè€Œæ˜¯æŠŠæ ¸å¿ƒçš„ä¸€ç‚¹åšå¥½ã€‚{'ä»£ç å¼€æºåœ¨ GitHub ä¸Šï¼Œæœ‰å…´è¶£å®ç°ç»†èŠ‚çš„å¯ä»¥å»çœ‹çœ‹æºç ã€‚' if 'github' in url.lower() else 'åˆšå‘å¸ƒä¸ä¹…ï¼Œå»ºè®®å…ˆè§‚å¯Ÿä¸€ä¸¤ä¸ªæœˆçš„è¿­ä»£æƒ…å†µå†å†³å®šæ˜¯å¦æ·±åº¦ä½¿ç”¨ã€‚'}"""
    
    # æ·»åŠ é“¾æ¥ - è‡ªç„¶ç»“æŸ
    return story.strip() + f"\n\n{url}"

def check_structured_output(content: str) -> tuple:
    """æ£€æŸ¥æ˜¯å¦æœ‰ç»“æ„åŒ–è¾“å‡ºï¼Œè¿”å›(æ˜¯å¦ç»“æ„åŒ–, å‘ç°çš„é—®é¢˜åˆ—è¡¨)"""
    
    structured_patterns = [
        # åºå·ç±»
        (r'ç¬¬ä¸€|ç¬¬äºŒ|ç¬¬ä¸‰|é¦–å…ˆ|å…¶æ¬¡|æœ€å', 'ä½¿ç”¨äº†åºå·æ ‡è®°'),
        (r'[â‘ â‘¡â‘¢â‘£â‘¤]', 'ä½¿ç”¨äº†ç¬¦å·åºå·'),
        (r'^\s*[0-9]+[.ã€]', 'ä½¿ç”¨äº†æ•°å­—åºå·'),
        
        # åˆ—è¡¨ç±»
        (r'^[â€¢Â·-]\s', 'ä½¿ç”¨äº†åˆ—è¡¨ç¬¦å·'),
        (r'ä¸»è¦åŠŸèƒ½åŒ…æ‹¬[:ï¼š]', 'ä½¿ç”¨äº†"ä¸»è¦åŠŸèƒ½åŒ…æ‹¬"'),
        (r'ä½¿ç”¨åœºæ™¯[:ï¼š]', 'ä½¿ç”¨äº†"ä½¿ç”¨åœºæ™¯"'),
        (r'æŠ€æœ¯ç»†èŠ‚[:ï¼š]', 'ä½¿ç”¨äº†"æŠ€æœ¯ç»†èŠ‚"'),
        (r'ä¼˜ç¼ºç‚¹[:ï¼š]', 'ä½¿ç”¨äº†"ä¼˜ç¼ºç‚¹"'),
        (r'æ ¸å¿ƒåŠŸèƒ½[:ï¼š]', 'ä½¿ç”¨äº†"æ ¸å¿ƒåŠŸèƒ½"'),
        
        # åˆ†æ®µæ ‡è®°
        (r'ã€', 'ä½¿ç”¨äº†ã€ã€‘ç¬¦å·'),
        (r'ã€‘', 'ä½¿ç”¨äº†ã€ã€‘ç¬¦å·'),
        
        # å›ºå®šå¥å¼ - ç©ºè¯å¥—è¯
        (r'ä».*æ¥çœ‹', 'ä½¿ç”¨äº†"ä»...æ¥çœ‹"å¥å¼'),
        (r'ç»¼ä¸Šæ‰€è¿°', 'ä½¿ç”¨äº†"ç»¼ä¸Šæ‰€è¿°"'),
        (r'æ€»çš„æ¥è¯´', 'ä½¿ç”¨äº†"æ€»çš„æ¥è¯´"'),
        (r'é’ˆå¯¹ç—›ç‚¹', 'ä½¿ç”¨äº†"é’ˆå¯¹ç—›ç‚¹"'),
        (r'é’ˆå¯¹.*éœ€æ±‚', 'ä½¿ç”¨äº†"é’ˆå¯¹...éœ€æ±‚"'),
        (r'åŠŸèƒ½è®¾è®¡', 'ä½¿ç”¨äº†"åŠŸèƒ½è®¾è®¡"'),
        (r'è§£å†³æ–¹æ¡ˆ', 'ä½¿ç”¨äº†"è§£å†³æ–¹æ¡ˆ"'),
        (r'æ—¨åœ¨è§£å†³', 'ä½¿ç”¨äº†"æ—¨åœ¨è§£å†³"'),
        (r'è‡´åŠ›äº', 'ä½¿ç”¨äº†"è‡´åŠ›äº"'),
        (r'é€šè¿‡.*æ–¹å¼', 'ä½¿ç”¨äº†"é€šè¿‡...æ–¹å¼"'),
        (r'åŸºäº.*æŠ€æœ¯', 'ä½¿ç”¨äº†"åŸºäº...æŠ€æœ¯"'),
        (r'é‡‡ç”¨.*æ¶æ„', 'ä½¿ç”¨äº†"é‡‡ç”¨...æ¶æ„"'),
        (r'å®ç°äº†', 'ä½¿ç”¨äº†"å®ç°äº†"'),
        (r'æä¾›äº†', 'ä½¿ç”¨äº†"æä¾›äº†"'),
        (r'æ”¯æŒ.*åŠŸèƒ½', 'ä½¿ç”¨äº†"æ”¯æŒ...åŠŸèƒ½"'),
        
        # ç»“æ„æ€§åˆ†æ®µ
        (r'\n\n.*[:ï¼š]\n', 'ä½¿ç”¨äº†æ ‡é¢˜å¼åˆ†æ®µ'),
    ]
    
    import re
    issues = []
    
    for pattern, desc in structured_patterns:
        if re.search(pattern, content, re.MULTILINE):
            issues.append(desc)
    
    # æ£€æŸ¥é‡å¤æ®µè½ï¼ˆä¸¤ç¯‡å†…å®¹ç›¸ä¼¼åº¦ï¼‰
    return (len(issues) > 0, issues)

def main():
    """æµ‹è¯•ç”Ÿæˆå†…å®¹"""
    
    test_articles = [
        {
            'title': '[Show HN] Wikipedia as a doomscrollable social media feed',
            'url': 'https://xikipedia.org',
            'source': 'hackernews',
            'summary': 'A browser extension that turns Wikipedia into an infinite scrolling feed.',
            'metadata': {'comments': 82}
        },
        {
            'title': '[Show HN] Ã†THRA â€“ Writing Music as Code',
            'url': 'https://aethra.dev',
            'source': 'hackernews',
            'summary': 'A programming language for music composition.',
            'metadata': {'comments': 45}
        },
        {
            'title': '[Product Hunt] Amara â­108',
            'url': 'https://amara.dev',
            'source': 'producthunt',
            'summary': 'Build your 3D environment through exploration.',
            'metadata': {'score': 108}
        }
    ]
    
    print("="*60)
    print("ğŸ§ª æµ‹è¯•å®Œå…¨è‡ªç”±å™è¿°ç”Ÿæˆ")
    print("="*60)
    
    for i, article in enumerate(test_articles, 1):
        print(f"\n{'='*60}")
        print(f"æµ‹è¯• {i}: {article['title'][:40]}...")
        print('='*60)
        
        content = generate_fully_free_content(article)
        
        # æ£€æŸ¥ç»“æ„åŒ–
        is_structured, issues = check_structured_output(content)
        
        print(f"\nç”Ÿæˆå†…å®¹ ({len(content)} å­—ç¬¦):")
        print(content[:500] + "..." if len(content) > 500 else content)
        
        if is_structured:
            print(f"\nâŒ å‘ç°ç»“æ„åŒ–é—®é¢˜: {', '.join(issues)}")
        else:
            print(f"\nâœ… æ— ç»“æ„åŒ–ç—•è¿¹")

if __name__ == '__main__':
    main()
